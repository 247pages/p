<!DOCTYPE html>
<html>
<head>
  <title>JioPhone CCTV Sender</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family:sans-serif; text-align:center; background:#111; color:#eee; }
    video { width:95%; max-height:200px; margin:5px; background:#000; }
    button { padding:8px; margin:10px; width:90%; font-size:14px; }
    textarea { width:90%; height:80px; font-size:12px; margin-top:5px; }
    pre { text-align:left; background:#222; padding:5px; font-size:12px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <h3>üìπ Jio CCTV Sender</h3>
  <video id="local" autoplay muted playsinline></video>
  <button onclick="start()">Start CCTV</button>
  <pre id="log">Idle...</pre>

  <h4>Paste Remote ICE Candidate:</h4>
  <textarea id="remoteIceArea" placeholder="Paste Admin ICE JSON"></textarea>
  <button onclick="addRemoteIce()">Add Remote ICE</button>

  <script>
    var logEl = document.getElementById("log");
    function log(msg) { logEl.innerText += "\n" + msg; }

    var BOT_TOKEN = "6675607272:AAFIafZckGOmNT8m9mE66_YgaBzkD3wo_xg";
    var CHAT_ID = "-1001590820560";
    var OFFER_FILE = "offer.json"; // hosted in GitHub repo
    var pc;

    function start() {
      log("‚ñ∂Ô∏è Start pressed");

      // Setup PeerConnection
      pc = new RTCPeerConnection();
      pc.onconnectionstatechange = function() {
        log("Conn: " + pc.connectionState);
      };

      // ICE candidates
      pc.onicecandidate = function(e) {
        if (e.candidate) {
          log("üì§ Sending ICE candidate...");
          sendToTelegram("JIO_ICE:" + JSON.stringify(e.candidate));
        } else {
          log("‚úÖ Finished gathering ICE");
        }
      };

      // Capture camera + mic
      log("Requesting camera/mic...");
      navigator.mediaDevices.getUserMedia({ video:true, audio:true })
        .then(function(stream) {
          document.getElementById("local").srcObject = stream;
          stream.getTracks().forEach(track => pc.addTrack(track, stream));
          log("‚úÖ Camera started, fetching offer...");
          fetchOffer();
        })
        .catch(function(err) {
          log("‚ùå getUserMedia error: " + err.name + " - " + err.message);
        });
    }

    // Fetch offer.json from GitHub
    function fetchOffer() {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", OFFER_FILE + "?_=" + Date.now(), true); // cache-bust
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              var offer = JSON.parse(xhr.responseText);
              log("‚úÖ Offer fetched, setting remote description...");
              pc.setRemoteDescription(new RTCSessionDescription(offer))
                .then(() => {
                  log("Creating answer...");
                  return pc.createAnswer();
                })
                .then(answer => pc.setLocalDescription(answer))
                .then(() => {
                  log("üì§ Sending SDP answer to Telegram...");
                  sendToTelegram("JIO_ANSWER:" + JSON.stringify(pc.localDescription));
                })
                .catch(err => log("‚ùå SDP error: " + err));
            } catch(e) {
              log("‚ùå JSON parse error: " + e);
            }
          } else {
            log("‚ùå Failed to fetch offer.json, retrying in 3s...");
            setTimeout(fetchOffer, 3000);
          }
        }
      };
      xhr.send();
    }

    // Add remote ICE candidate from Admin
    function addRemoteIce() {
      try {
        var cand = JSON.parse(document.getElementById("remoteIceArea").value);
        pc.addIceCandidate(new RTCIceCandidate(cand))
          .then(() => log("‚úÖ Remote ICE added"))
          .catch(err => log("‚ùå ICE add error: " + err));
      } catch(e) {
        log("‚ùå Invalid ICE JSON: " + e);
      }
    }

    // Send to Telegram
    function sendToTelegram(text) {
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "https://api.telegram.org/bot" + BOT_TOKEN + "/sendMessage", true);
      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.send(JSON.stringify({ chat_id: CHAT_ID, text: text }));
    }
  </script>
</body>
</html>

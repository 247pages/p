<!DOCTYPE html>
<html>
<head>
  <title>JioPhone CCTV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family:sans-serif; text-align:center; background:#111; color:#eee; }
    video { width:95%; max-height:200px; margin:5px; background:#000; }
    button { padding:8px; margin:10px; width:90%; font-size:14px; }
    #log { font-size:12px; white-space:pre-wrap; text-align:left; margin:5px; background:#222; padding:5px; }
  </style>
</head>
<body>
  <h3>üìπ Jio CCTV Sender</h3>
  <video id="local" autoplay muted playsinline></video>
  <button onclick="start()">Start CCTV</button>
  <div id="log">Idle...</div>

  <script>
    const log = msg => {
      console.log(msg);
      document.getElementById("log").innerText += "\n" + msg;
    };

    let pc;
    const BOT_TOKEN = "6675607272:AAFIafZckGOmNT8m9mE66_YgaBzkD3wo_xg";
    const CHAT_ID = "-1001590820560";

    async function start() {
      log("‚ñ∂Ô∏è Start pressed");

      // peer connection
      pc = new RTCPeerConnection();
      pc.onconnectionstatechange = () => log("Conn: " + pc.connectionState);

      // ---- CAMERA ----
      let gotStream = false;

      async function modernAPI() {
        log("Trying modern getUserMedia...");
        let stream = await navigator.mediaDevices.getUserMedia({
          video: { width:160, height:120, frameRate:10 },
          audio: true
        });
        document.getElementById("local").srcObject = stream;
        stream.getTracks().forEach(t => pc.addTrack(t, stream));
        gotStream = true;
        log("‚úÖ Camera stream acquired");
      }

      function oldAPI() {
        return new Promise((resolve, reject) => {
          if (!navigator.getUserMedia) {
            reject("old getUserMedia not available");
            return;
          }
          log("Trying old getUserMedia...");
          navigator.getUserMedia(
            { video:true, audio:true },
            stream => {
              document.getElementById("local").srcObject = stream;
              stream.getTracks().forEach(t => pc.addTrack(t, stream));
              gotStream = true;
              log("‚úÖ Camera stream acquired (old API)");
              resolve();
            },
            err => reject("old getUserMedia error: " + err)
          );
        });
      }

      try {
        await modernAPI();
      } catch(e1) {
        log("Modern API failed: " + e1);
        try {
          await oldAPI();
        } catch(e2) {
          log("Both APIs failed: " + e2);
          return;
        }
      }

      // ---- FETCH OFFER ----
      try {
        log("Fetching offer.json...");
        let res = await fetch("offer.json?_=" + Date.now());
        let offer = await res.json();
        log("Offer loaded");
        await pc.setRemoteDescription(offer);
      } catch(e) {
        log("‚ùå Offer fetch/set failed: " + e);
        return;
      }

      // ---- CREATE ANSWER ----
      try {
        log("Creating answer...");
        let answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        pc.onicecandidate = async e => {
          if (!e.candidate && pc.localDescription) {
            let ansText = JSON.stringify(pc.localDescription);
            log("Sending answer to Telegram...");
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                chat_id: CHAT_ID,
                text: ansText
              })
            });
            log("‚úÖ Answer sent to Telegram");
          }
        };
      } catch(e) {
        log("‚ùå Answer creation failed: " + e);
      }
    }
  </script>
</body>
</html>

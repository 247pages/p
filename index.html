<!DOCTYPE html>
<html>
<head>
  <title>JioPhone CCTV Snapshots</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family:sans-serif; background:#111; color:#eee; text-align:center; }
    video { width:90%; background:#000; margin:10px; }
    button { padding:10px; margin:10px; width:90%; font-size:14px; }
    pre { text-align:left; background:#222; padding:5px; font-size:12px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <h3>üì∏ JioPhone CCTV Snapshots</h3>
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <button onclick="start()">Start Sending</button>
  <button onclick="stop()">Stop</button>
  <pre id="log">Idle...</pre>

  <script>
    var BOT_TOKEN = "6675607272:AAFIafZckGOmNT8m9mE66_YgaBzkD3wo_xg";
    var CHAT_ID = "-1001590820560";

    var video = document.getElementById("video");
    var canvas = document.getElementById("canvas");
    var logEl = document.getElementById("log");
    var intervalId = null;

    function log(msg) {
      logEl.innerText += "\n" + msg;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function start() {
      log("‚ñ∂Ô∏è Starting camera...");
      // Use old getUserMedia for KaiOS
      var gum = (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) ||
                navigator.getUserMedia ||
                navigator.webkitGetUserMedia ||
                navigator.mozGetUserMedia;

      if (!gum) {
        log("‚ùå getUserMedia not supported on this device");
        return;
      }

      gum.call(navigator, { video: true, audio: false }, function(stream) {
        video.srcObject = stream;
        log("‚úÖ Camera started");
        intervalId = setInterval(captureAndSend, 5000);
      }, function(err) {
        log("‚ùå Camera error: " + err.message);
      });
    }

    function stop() {
      if (intervalId) clearInterval(intervalId);
      intervalId = null;
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(t => t.stop());
        video.srcObject = null;
      }
      log("‚èπÔ∏è Stopped");
    }

    function captureAndSend() {
      if (!video.videoWidth) {
        log("‚ö†Ô∏è Waiting for video...");
        return;
      }

      var ctx = canvas.getContext("2d");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      var dataURL = canvas.toDataURL("image/jpeg", 0.5);

      log("üì§ Sending snapshot...");
      sendToTelegram(dataURL);
    }

    function sendToTelegram(base64Image) {
      // Strip prefix "data:image/jpeg;base64,"
      var b64 = base64Image.split(",")[1];
      var blob = b64ToBlob(b64, "image/jpeg");

      var formData = new FormData();
      formData.append("chat_id", CHAT_ID);
      formData.append("photo", blob, "snapshot.jpg");

      var xhr = new XMLHttpRequest();
      xhr.open("POST", "https://api.telegram.org/bot" + BOT_TOKEN + "/sendPhoto", true);
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) log("‚úÖ Sent to Telegram");
          else log("‚ùå Error: " + xhr.status);
        }
      };
      xhr.send(formData);
    }

    function b64ToBlob(b64Data, contentType) {
      var byteChars = atob(b64Data);
      var byteArrays = [];
      for (var offset = 0; offset < byteChars.length; offset += 512) {
        var slice = byteChars.slice(offset, offset + 512);
        var byteNumbers = new Array(slice.length);
        for (var i = 0; i < slice.length; i++) {
          byteNumbers[i] = slice.charCodeAt(i);
        }
        byteArrays.push(new Uint8Array(byteNumbers));
      }
      return new Blob(byteArrays, {type: contentType});
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>JioPhone CCTV Sender</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family:sans-serif; text-align:center; background:#111; color:#eee; }
    video { width:95%; max-height:200px; margin:5px; background:#000; }
    button { padding:8px; margin:10px; width:90%; font-size:14px; }
    pre { text-align:left; background:#222; padding:5px; font-size:12px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <h3>üìπ Jio CCTV Sender</h3>
  <video id="local" autoplay muted playsinline></video>
  <button onclick="start()">Start CCTV</button>
  <pre id="log">Idle...</pre>

  <script>
    var logEl = document.getElementById("log");
    function log(msg) { logEl.innerText += "\n" + msg; }

    var BOT_TOKEN = "6675607272:AAFIafZckGOmNT8m9mE66_YgaBzkD3wo_xg";
    var CHAT_ID = "-1001590820560";
    var OFFER_FILE = "offer.json"; // hosted in GitHub repo
    var pc;

    function start() {
      log("‚ñ∂Ô∏è Start pressed");

      // Setup PeerConnection
      pc = new RTCPeerConnection();
      pc.onconnectionstatechange = function() {
        log("Conn: " + pc.connectionState);
      };
      pc.onicecandidate = function(e) {
        if (!e.candidate && pc.localDescription) {
          log("Sending answer to Telegram...");
          sendToTelegram(JSON.stringify(pc.localDescription));
        }
      };

      // Capture camera + mic
      log("Requesting camera/mic...");
      navigator.mediaDevices.getUserMedia({ video:true, audio:true })
        .then(function(stream) {
          var localVideo = document.getElementById("local");
          localVideo.srcObject = stream;
          for (var i=0; i<stream.getTracks().length; i++) {
            pc.addTrack(stream.getTracks()[i], stream);
          }
          log("‚úÖ Camera started, fetching offer...");
          fetchOffer();
        })
        .catch(function(err) {
          log("‚ùå getUserMedia error: " + err.name + " - " + err.message);
        });
    }

    // Fetch offer.json from GitHub using XHR
    function fetchOffer() {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", OFFER_FILE + "?_=" + Date.now(), true); // cache-bust
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              var offer = JSON.parse(xhr.responseText);
              log("‚úÖ Offer fetched, setting remote description...");
              pc.setRemoteDescription(new RTCSessionDescription(offer))
                .then(function() {
                  log("Creating answer...");
                  pc.createAnswer()
                    .then(function(answer) {
                      return pc.setLocalDescription(answer);
                    })
                    .then(function() {
                      log("‚úÖ Answer ready, will be sent automatically");
                    })
                    .catch(function(err) { log("‚ùå Answer error: " + err); });
                })
                .catch(function(err) { log("‚ùå setRemoteDescription error: " + err); });
            } catch(e) {
              log("‚ùå JSON parse error: " + e);
            }
          } else {
            log("‚ùå Failed to fetch offer.json, retrying in 3s...");
            setTimeout(fetchOffer, 3000);
          }
        }
      };
      xhr.send();
    }

    // Send SDP answer to Telegram
    function sendToTelegram(text) {
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "https://api.telegram.org/bot" + BOT_TOKEN + "/sendMessage", true);
      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) log("‚úÖ Answer sent to Telegram");
          else log("‚ùå Telegram send error: " + xhr.status);
        }
      };
      xhr.send(JSON.stringify({ chat_id: CHAT_ID, text: text }));
    }
  </script>
</body>
</html>
